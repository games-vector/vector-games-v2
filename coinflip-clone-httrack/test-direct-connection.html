<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinFlip Direct Connection Test</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #2d5016; }
        .error { background: #5c1a1a; }
        .info { background: #1a3a5c; }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover { background: #45a049; }
        #logs {
            background: #000;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üéÆ CoinFlip Direct Backend Connection Test</h1>
    
    <div class="status info">
        <strong>Backend:</strong> http://localhost:3000<br>
        <strong>WebSocket Path:</strong> /io<br>
        <strong>Game Mode:</strong> coinflip
    </div>

    <div id="status" class="status">Status: Not connected</div>

    <div>
        <button onclick="getToken()">1. Get Dev Token</button>
        <button onclick="connectSocket()">2. Connect WebSocket</button>
        <button onclick="placeBet()">3. Place Bet (QUICK)</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <h3>Logs:</h3>
    <div id="logs"></div>

    <script>
        let socket = null;
        let authToken = null;
        const API_URL = 'http://localhost:3000';
        const WS_PATH = '/io';

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#74c0fc';
            logs.innerHTML += `<div style="color: ${color}">[${time}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }

        function updateStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = isError ? 'status error' : 'status success';
        }

        async function getToken() {
            try {
                log('Requesting dev token...', 'info');
                const response = await fetch(`${API_URL}/api/dev-game-token?userId=testuser001&operatorId=dev-operator&currency=USD&game_mode=coinflip`);
                const data = await response.json();
                
                if (data.token) {
                    authToken = data.token;
                    log(`‚úÖ Token received: ${authToken.substring(0, 50)}...`, 'success');
                    updateStatus('Token received successfully');
                } else {
                    throw new Error('No token in response');
                }
            } catch (error) {
                log(`‚ùå Error getting token: ${error.message}`, 'error');
                updateStatus('Failed to get token', true);
            }
        }

        function connectSocket() {
            if (!authToken) {
                log('‚ùå Please get a token first!', 'error');
                return;
            }

            log('Connecting to WebSocket...', 'info');
            
            socket = io(API_URL, {
                path: WS_PATH,
                query: {
                    gameMode: 'coinflip',
                    operatorId: 'dev-operator',
                    Authorization: authToken
                },
                transports: ['websocket']
            });

            socket.on('connect', () => {
                log('‚úÖ WebSocket connected!', 'success');
                updateStatus('Connected to backend');
            });

            socket.on('connect_error', (error) => {
                log(`‚ùå Connection error: ${error.message}`, 'error');
                updateStatus('Connection failed', true);
            });

            socket.on('disconnect', () => {
                log('‚ö†Ô∏è WebSocket disconnected', 'error');
                updateStatus('Disconnected', true);
            });

            // Listen for game events
            socket.on('onBalanceChange', (data) => {
                log(`üí∞ Balance: ${data.balance} ${data.currency}`, 'success');
            });

            socket.on('betsConfig', (data) => {
                log(`‚öôÔ∏è Bets config received: ${JSON.stringify(data)}`, 'info');
            });

            socket.on('myData', (data) => {
                log(`üë§ User data: ${JSON.stringify(data)}`, 'info');
            });

            socket.on('error', (error) => {
                log(`‚ùå Socket error: ${JSON.stringify(error)}`, 'error');
            });
        }

        function placeBet() {
            if (!socket || !socket.connected) {
                log('‚ùå Please connect WebSocket first!', 'error');
                return;
            }

            log('Placing QUICK bet (0.30 INR, HEADS)...', 'info');
            
            socket.emit('gameService', {
                action: 'bet',
                payload: {
                    betAmount: '0.30',
                    currency: 'INR',
                    choice: 'HEADS',
                    playMode: 'QUICK'
                }
            }, (response) => {
                if (response.error) {
                    log(`‚ùå Bet failed: ${response.error.message}`, 'error');
                } else {
                    log(`‚úÖ Bet result: ${JSON.stringify(response, null, 2)}`, 'success');
                    if (response.isWin) {
                        log(`üéâ YOU WON! Amount: ${response.winAmount}`, 'success');
                    } else {
                        log(`üò¢ You lost. Better luck next time!`, 'info');
                    }
                }
            });
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // Auto-log on page load
        log('Test page loaded. Click "Get Dev Token" to start.', 'info');
    </script>
</body>
</html>
