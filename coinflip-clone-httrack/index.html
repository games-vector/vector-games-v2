<!DOCTYPE html>
<html lang="en" translate="no">
  <head>
    <meta charset="utf-8" />
    <title>CoinFlipClient</title>
    <base href="./" />
    <meta
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
      name="viewport"
    />
    <link rel="apple-touch-icon" sizes="57x57" href="favicon-57x57.png" />
    <link rel="apple-touch-icon" sizes="60x60" href="favicon-60x60.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="favicon-72x72.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="favicon-76x76.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="favicon-114x114.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="favicon-120x120.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="favicon-144x144.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="favicon-152x152.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="favicon-180x180.png" />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="favicon-192x192.png" />
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <meta name="msapplication-TileColor" content="#ffffff" />
    <meta name="msapplication-TileImage" content="favicon-144x144.png" />
    <meta name="msapplication-config" content="browserconfig.xml" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#ffffff" />

    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;800;900&display=swap"
      rel="stylesheet"
    />
    <link href="static/css/849.65283bc1.css" rel="stylesheet">
    <link href="static/css/index.c38f240d.css" rel="stylesheet">
  </head>
  <body>
    <div id="root"></div>
    <script>
      (async function initAuth() {
        const params = new URLSearchParams(window.location.search);
        const operatorId = params.get('operatorId') || 'brlag';
        const gameMode = params.get('gameMode') || 'coinflip';
        const currency = params.get('currency') || 'INR';
        const API_URL = "http://localhost:3000";

        // Initialize window.env with all required values
        window.env = {
          VITE_API_ENDPOINT: API_URL,
          VITE_WS_ENDPOINT: API_URL,
          VITE_WS_PATH: "/io",
          VITE_GAME_MODE: gameMode,
          VITE_OPERATOR_ID: operatorId,
          VITE_DEFAULT_CURRENCY: currency,
          VITE_DEFAULT_LANGUAGE: "en",
          VITE_TOLGEE_CDN: 'https://i18n.inout.games/1febfee655c493da075c27793d33b5f9',
          LAUNCHDARKLY_KEY: "66cd66a0ee056b104ba45da5",
          VITE_APP_TOLGEE_API_URL: 'https://tolgee.inout.games',
          VITE_APP_TOLGEE_API_KEY: 'tgpak_gfpw22dhojzwon3gnbtw4mdtorxwo3rqmv2xiolcgbttc',
          VITE_ASSETS_ENDPOINT: "https://inout-assets.s3.eu-central-1.amazonaws.com",
          VITE_SENTRY_DSN: "",
          VITE_SENTRY_URL: "",
          VITE_HJID: "",
          VITE_SENTRY_ID: "",
          VITE_GAMES_BASE_URL: "inout.games",
          VITE_MATOMO_URL: "",
          VITE_MATOMO_ID: "",
          IS_LOBBY_ENABLED: false,
        };

        try {
          // Step 1: Get dev token
          console.log('[Auth] Getting dev token...');
          const devResp = await fetch(`${API_URL}/api/dev-game-token?userId=testuser001&operatorId=${operatorId}&currency=${currency}&game_mode=${gameMode}`);
          const devData = await devResp.json();

          // Step 2: Authenticate and get JWT
          console.log('[Auth] Authenticating...');
          const authResp = await fetch(`${API_URL}/api/auth`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              operator: operatorId,
              auth_token: devData.token,
              currency: currency,
              game_mode: gameMode
            })
          });
          const authData = await authResp.json();

          if (authData.success && authData.jwt) {
            // Set JWT before React loads
            window.env.JWT = authData.jwt;
            console.log('[Auth] Success! JWT set.');

            // Also add authToken to URL for React's internal WebSocket logic
            const newParams = new URLSearchParams(window.location.search);
            newParams.set('authToken', authData.jwt);
            window.history.replaceState({}, '', '?' + newParams.toString());
          } else {
            console.error('[Auth] Failed:', authData);
          }
        } catch (err) {
          console.error('[Auth] Error:', err);
        }

        // Load socket.io first
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdn.socket.io/4.5.4/socket.io.min.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
        console.log('[Auth] Socket.io loaded');

        // Pre-establish socket connection and store initial data
        if (window.env.JWT) {
          console.log('[Auth] Establishing WebSocket connection...');
          const socket = io(window.env.VITE_WS_ENDPOINT, {
            path: window.env.VITE_WS_PATH,
            query: {
              gameMode: window.env.VITE_GAME_MODE,
              operatorId: window.env.VITE_OPERATOR_ID,
              Authorization: window.env.JWT
            },
            transports: ['websocket'],
            reconnection: true
          });

          // Store socket globally for React app
          window.gameSocket = socket;
          window.socketInstance = socket;

          // Wait for connection and initial data
          await new Promise((resolve) => {
            let dataReceived = { balance: false, config: false, userData: false };

            socket.on('connect', () => {
              console.log('[Auth] WebSocket connected!');
            });

            socket.on('onBalanceChange', (data) => {
              console.log('[Auth] Balance received:', data.balance, data.currency);
              window.initialBalance = data;
              dataReceived.balance = true;
              checkComplete();
            });

            socket.on('betsConfig', (data) => {
              console.log('[Auth] Bets config received');
              window.betsConfig = data;
              dataReceived.config = true;
              checkComplete();
            });

            socket.on('myData', (data) => {
              console.log('[Auth] User data received');
              window.userData = data;
              dataReceived.userData = true;
              checkComplete();
            });

            socket.on('connect_error', (err) => {
              console.error('[Auth] Socket error:', err.message);
              resolve(); // Continue anyway
            });

            function checkComplete() {
              if (dataReceived.balance && dataReceived.config && dataReceived.userData) {
                console.log('[Auth] All initial data received, loading React...');
                resolve();
              }
            }

            // Timeout fallback
            setTimeout(() => {
              console.log('[Auth] Timeout waiting for data, loading React anyway...');
              resolve();
            }, 3000);
          });
        }

        // Load React scripts
        const scripts = [
          'static/js/lib-axios.06a4e25e.js',
          'static/js/lib-react.c1e8bdb7.js',
          'static/js/849.e4490c65.js',
          'static/js/index.a4de0872.js'
        ];

        for (const src of scripts) {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.body.appendChild(script);
          });
        }
      })();
    </script>
  </body>
</html>
